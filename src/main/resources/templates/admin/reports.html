<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="container">
        <section class="page-header">
            <div class="header-content">
                <h1>Reports & Analytics</h1>
                <p>View platform statistics and insights</p>
            </div>
            <div class="header-actions">
                <button onclick="downloadAllCharts()" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download All Charts
                </button>
            </div>
        </section>

        <div class="reports-grid">
            <!-- Setlists by Artist -->
            <div class="report-card" id="setlistsChartCard">
                <div class="report-header">
                    <h2>Setlists by Artist</h2>
                    <button onclick="downloadChart('setlistsChart', 'Setlists by Artist')" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div th:if="${setlistsByArtist == null || setlistsByArtist.isEmpty()}" class="no-data">
                    No data available
                </div>
                <canvas th:unless="${setlistsByArtist == null || setlistsByArtist.isEmpty()}" id="setlistsChart"></canvas>
            </div>
            
            <!-- Events by Venue -->
            <div class="report-card" id="eventsChartCard">
                <div class="report-header">
                    <h2>Events by Venue</h2>
                    <button onclick="downloadChart('eventsChart', 'Events by Venue')" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div th:if="${eventsByVenue == null || eventsByVenue.isEmpty()}" class="no-data">
                    No data available
                </div>
                <canvas th:unless="${eventsByVenue == null || eventsByVenue.isEmpty()}" id="eventsChart"></canvas>
            </div>
            
            <!-- Songs by Artist -->
            <div class="report-card" id="songsChartCard">
                <div class="report-header">
                    <h2>Songs by Artist</h2>
                    <button onclick="downloadChart('songsChart', 'Songs by Artist')" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div th:if="${songsByArtist == null || songsByArtist.isEmpty()}" class="no-data">
                    No data available
                </div>
                <canvas th:unless="${songsByArtist == null || songsByArtist.isEmpty()}" id="songsChart"></canvas>
            </div>
            
            <!-- Monthly Setlists -->
            <div class="report-card" id="monthlyChartCard">
                <div class="report-header">
                    <h2>Monthly Setlist Submissions</h2>
                    <button onclick="downloadChart('monthlyChart', 'Monthly Setlist Submissions')" class="btn btn-sm btn-outline">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div th:if="${monthlySetlists == null || monthlySetlists.isEmpty()}" class="no-data">
                    No data available
                </div>
                <canvas th:unless="${monthlySetlists == null || monthlySetlists.isEmpty()}" id="monthlyChart"></canvas>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        window.jsPDF = window.jspdf.jsPDF;
        
        // Get data from Thymeleaf with default empty objects
        const setlistsByArtist = /*[[${setlistsByArtist}]]*/ {};
        const eventsByVenue = /*[[${eventsByVenue}]]*/ {};
        const songsByArtist = /*[[${songsByArtist}]]*/ {};
        const monthlySetlists = /*[[${monthlySetlists}]]*/ {};

        // Chart configurations with larger font sizes for better readability in PDF
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    font: {
                        size: 18,
                        weight: 'bold'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        };

        // Helper function to safely initialize charts
        function initializeChart(elementId, type, labels, data, options = {}) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const chartData = {
                labels: labels || [],
                datasets: [{
                    label: options.label || '',
                    data: data || [],
                    backgroundColor: options.backgroundColor || 'rgba(54, 162, 235, 0.5)',
                    borderColor: options.borderColor,
                    tension: options.tension
                }]
            };

            const config = { 
                ...chartConfig, 
                ...options,
                plugins: {
                    ...chartConfig.plugins,
                    title: {
                        ...chartConfig.plugins.title,
                        text: options.title
                    }
                }
            };

            return new Chart(element, {
                type: type,
                data: chartData,
                options: config
            });
        }

        // Initialize charts only if data exists
        let charts = {};

        if (setlistsByArtist && Object.keys(setlistsByArtist).length > 0) {
            charts.setlists = initializeChart('setlistsChart', 'bar', 
                Object.keys(setlistsByArtist),
                Object.values(setlistsByArtist),
                { 
                    label: 'Number of Setlists',
                    title: 'Setlists by Artist'
                }
            );
        }

        if (eventsByVenue && Object.keys(eventsByVenue).length > 0) {
            charts.events = initializeChart('eventsChart', 'pie',
                Object.keys(eventsByVenue),
                Object.values(eventsByVenue),
                {
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)'
                    ],
                    title: 'Events by Venue'
                }
            );
        }

        if (songsByArtist && Object.keys(songsByArtist).length > 0) {
            charts.songs = initializeChart('songsChart', 'bar',
                Object.keys(songsByArtist),
                Object.values(songsByArtist),
                { 
                    label: 'Number of Songs',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    title: 'Songs by Artist'
                }
            );
        }

        if (monthlySetlists && Object.keys(monthlySetlists).length > 0) {
            const sortedMonths = Object.keys(monthlySetlists).sort().reverse();
            charts.monthly = initializeChart('monthlyChart', 'line',
                sortedMonths,
                sortedMonths.map(month => monthlySetlists[month]),
                {
                    label: 'Number of Setlists',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    tension: 0.1,
                    title: 'Monthly Setlist Submissions'
                }
            );
        }

        async function downloadChart(chartId, title) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;

            // Set canvas to fixed size for better quality
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            canvas.width = 1200;
            canvas.height = 800;

            // Update chart to redraw at new size
            const chart = Chart.getChart(chartId);
            if (chart) {
                chart.resize();
            }

            try {
                const pdf = new jsPDF('l', 'px', [canvas.width, canvas.height]);
                
                // Add title
                pdf.setFontSize(24);
                pdf.text(title, 40, 40);

                // Convert chart to image
                const image = await html2canvas(canvas);
                
                // Add image to PDF
                pdf.addImage(
                    image, 
                    'PNG', 
                    40, // x
                    60, // y
                    canvas.width - 80, // width
                    canvas.height - 100 // height
                );

                // Save PDF
                pdf.save(`${title.toLowerCase().replace(/ /g, '_')}_chart.pdf`);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }

            // Reset canvas to original size
            canvas.width = originalWidth;
            canvas.height = originalHeight;
            if (chart) {
                chart.resize();
            }
        }

        async function downloadAllCharts() {
            try {
                const pdf = new jsPDF('p', 'px', 'a4');
                const charts = document.querySelectorAll('canvas');
                let currentPage = 1;

                for (const canvas of charts) {
                    if (currentPage > 1) {
                        pdf.addPage();
                    }

                    // Get chart title
                    const card = canvas.closest('.report-card');
                    const title = card.querySelector('h2').textContent;

                    // Set fixed size for better quality
                    const originalWidth = canvas.width;
                    const originalHeight = canvas.height;
                    canvas.width = 1000;
                    canvas.height = 600;

                    // Update chart
                    const chart = Chart.getChart(canvas.id);
                    if (chart) {
                        chart.resize();
                    }

                    // Add title
                    pdf.setFontSize(20);
                    pdf.text(title, 40, 40);

                    // Convert chart to image
                    const image = await html2canvas(canvas);

                    // Add image to PDF
                    pdf.addImage(
                        image,
                        'PNG',
                        40, // x
                        60, // y
                        pdf.internal.pageSize.getWidth() - 80, // width
                        pdf.internal.pageSize.getHeight() - 100 // height
                    );

                    // Reset canvas
                    canvas.width = originalWidth;
                    canvas.height = originalHeight;
                    if (chart) {
                        chart.resize();
                    }

                    currentPage++;
                }

                // Save PDF
                pdf.save('all_charts.pdf');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }
        }
        /*]]>*/
    </script>

    <style>
        .no-data {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            background-color: #f8f9fa;
            border-radius: 8px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 300px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #4A90E2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #357ABD;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #4A90E2;
            color: #4A90E2;
        }

        .btn-outline:hover {
            background-color: #4A90E2;
            color: white;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.9rem;
        }

        .header-actions {
            margin-top: 20px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        canvas {
            width: 100% !important;
            height: 250px !important;
        }
    </style>
</body>
</html>